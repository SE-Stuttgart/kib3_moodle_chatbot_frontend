define("block_chatbot/chatbot",["exports","./local/selectors","./local/charts/donut/donut","./local/charts/line/line","jquery"],(function(_exports,_selectors,_donut,_line,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_selectors=_interopRequireDefault(_selectors),_donut=_interopRequireDefault(_donut),_line=_interopRequireDefault(_line),_jquery=_interopRequireDefault(_jquery);const sendMessage=user_input=>{console.log("SENDING"),conn.sendMessage(user_input),addUserMessage(user_input);(0,_jquery.default)("#block_chatbot-userUtterance").val("")},addUserMessage=utterance=>{(0,_jquery.default)(".block_chatbot-answer_candidate_list").remove();const messagelist=(0,_jquery.default)("#block_chatbot-messagelist");messagelist.append('\n        <div class="block_chatbot-speech-bubble block_chatbot-user">\n            <div class="block_chatbot-message" style="color: anthrazit">'.concat(utterance,"</div>\n        </div>\n    ")),messagelist.animate({scrollTop:messagelist.prop("scrollHeight")},500)},addSystemMessage=utterance=>{const messagelist=(0,_jquery.default)("#block_chatbot-messagelist"),content=utterance[0],answerCandidates=utterance[1];if(content.startsWith("$$")){const messageBubble=document.createElement("div");messageBubble.className="block_chatbot-speech-bubble block_chatbot-system";const message=document.createElement("div");message.className="block_chatbot-message",message.style.color="anthrazit",message.append((utterance=>{const args=utterance.split(";"),chart_type=args[0].replace("$$","");if("DONUT"===chart_type){const outerValue=args[1],innerValue=args[2];return new _donut.default(outerValue,"Kurs",innerValue,"Wiederholte Quizze").render()}if("LINECHART"===chart_type){const legendTitle1=args[1],values1=JSON.parse(args[2]),legendTitle2=args[3],values2=JSON.parse(args[4]);return new _line.default(legendTitle1,values1,legendTitle2,values2).render()}})(content)),messageBubble.append(message),messagelist.append(messageBubble)}else{var systemBubble=document.createElement("div");systemBubble.className="block_chatbot-speech-bubble block_chatbot-system";var systemMessage=document.createElement("div");if(systemMessage.innerHTML=content,systemMessage.className="block_chatbot-message",systemMessage.style.color="anthrazit",systemBubble.append(systemMessage),answerCandidates.length>0){var answer_candidate_el=document.createElement("div");answer_candidate_el.className="block_chatbot-answer_candidate_list",answerCandidates.forEach((cand=>{return answer_candidate_el.append((candidate=cand,(button=document.createElement("p")).className="block_chatbot-answer_candidate",button.textContent=candidate,button.onclick=()=>sendMessage(candidate),button));var candidate,button})),systemBubble.append(answer_candidate_el)}messagelist.append(systemBubble)}messagelist.animate({scrollTop:messagelist.prop("scrollHeight")},500)},setWindowState=maximized=>{console.log("Window state",maximized),maximized?((0,_jquery.default)("#block_chatbot-messagelist").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-inputContainer").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-chatwindowInner").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-headerMinimized").addClass("block_chatbot-hidden")):((0,_jquery.default)("#block_chatbot-messagelist").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-inputContainer").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-chatwindowInner").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-headerMinimized").removeClass("block_chatbot-hidden")),localStorage.setItem("chatbot.maximized",maximized?"true":"false")};class ChatbotConnection{constructor(server_name,server_port,userid,courseid,slidefindertoken,timestamp){_defineProperty(this,"openConnection",(()=>{console.log("Connecting to: ws://".concat(this.server_name,":").concat(this.server_port,"/ws?token=").concat(this.userid)),this.conn=new WebSocket("ws://".concat(this.server_name,":").concat(this.server_port,"/ws?token=").concat(this.userid)),this.conn.onopen=()=>{console.log("connected",this.userid);const start_dialog_msg={access_token:this.userid,domain:0,topic:"start_dialog",courseid:this.courseid,slidefindertoken:this.slidefindertoken,timestamp:this.timestamp};console.log("START MSG",start_dialog_msg),this.conn.send(JSON.stringify(start_dialog_msg))},this.conn.onmessage=msg=>{const data=JSON.parse(msg.data);console.log("Received data",data),data.forEach((message=>{"system"===message.party?addSystemMessage(message.content):"control"===message.party?"UI_OPEN"===message.content&&setWindowState(!0):addUserMessage(message.content)}))}})),_defineProperty(this,"sendMessage",(message=>{const msg={userid:this.userid,domain:0,topic:"user_utterance",courseid:this.courseid,msg:message};console.log("Sending message",msg),this.conn.send(JSON.stringify(msg))})),this.server_name=server_name,this.server_port=server_port,this.userid=userid,this.courseid=courseid,this.slidefindertoken=slidefindertoken,this.timestamp=timestamp,this.conn=null}}var conn;_exports.init=(server_name,server_port,server_url,userid,username,courseid,slidefindertoken,timestamp,plotly)=>{if(window.location!==window.parent.location)return void console.log("IFrame detected - Chatbot won't be loaded");console.log("SERVER",server_name),console.log("PORT",server_port),console.log("URL",server_url),console.log("USER",userid,username),console.log("COURSE",courseid),console.log("SLIDEFINDER TOKEN",slidefindertoken),console.log("TIMESTAMP",timestamp),plotly,document.addEventListener("click",(e=>{if(e.target.closest(_selectors.default.actions.maximiseChatWindow))window.alert("MAXIMISE");else if(e.target.closest(_selectors.default.actions.minimizeChatWindow))window.alert("MINIMIZE");else if(e.target.closest(_selectors.default.actions.sendMessage)){const user_input=(0,_jquery.default)("#block_chatbot-userUtterance").val();sendMessage(user_input)}else e.target.closest(_selectors.default.actions.toggleWindowState)&&setWindowState(!("true"===localStorage.getItem("chatbot.maximized")))})),document.addEventListener("keydown",(e=>{e.target.closest(_selectors.default.actions.textInput)&&"Enter"===e.key&&sendMessage()})),(conn=new ChatbotConnection(server_name,server_port,userid,courseid,slidefindertoken,timestamp)).openConnection();const chatwindow=(0,_jquery.default)("#block_chatbot-chatwindow");return chatwindow.detach(),(0,_jquery.default)(document.body).append(chatwindow),null===localStorage.getItem("chatbot.maximized")&&localStorage.setItem("chatbot.maximized","false"),setWindowState("true"===localStorage.getItem("chatbot.maximized")),conn}}));

//# sourceMappingURL=chatbot.min.js.map