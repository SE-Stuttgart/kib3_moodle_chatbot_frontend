define("block_chatbot/chatbot",["exports","./local/selectors","./local/charts/donut/donut","./local/charts/line/line","./local/settings","jquery"],(function(_exports,_selectors,_donut,_line,_settings,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}var conn,Plotly;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_selectors=_interopRequireDefault(_selectors),_donut=_interopRequireDefault(_donut),_line=_interopRequireDefault(_line),_jquery=_interopRequireDefault(_jquery);const openSettingsModal=()=>{setWindowState(!1),(0,_settings.fetchUserSetttings)(conn.userid,conn.slidefindertoken,conn.wwwroot).then((settings=>{(0,_settings.assignUserSettings)(settings)}))},sendMessage=user_input=>{conn.sendMessage(user_input),addUserMessage(user_input);(0,_jquery.default)("#block_chatbot-userUtterance").val("")},extend_chat_history=(party,message)=>{const storage_history=localStorage.getItem("chatbot.history");var chat_history=null===storage_history?[]:JSON.parse(storage_history);chat_history.push({party:party,message:message}),chat_history.length>10&&(chat_history=chat_history.slice(1),(0,_jquery.default)("#block_chatbot-messagelist:first-child").remove()),localStorage.setItem("chatbot.history",JSON.stringify(chat_history))},addUserMessage=function(utterance){let shouldScroll=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];(0,_jquery.default)(".block_chatbot-answer_candidate_list").remove();const messagelist=(0,_jquery.default)("#block_chatbot-messagelist");messagelist.append('\n        <div class="block_chatbot-speech-bubble block_chatbot-user">\n            <div class="block_chatbot-message" style="color: anthrazit">'.concat(utterance,"</div>\n        </div>\n    ")),extend_chat_history("user",utterance),shouldScroll?messagelist.animate({scrollTop:messagelist.prop("scrollHeight")},500):messagelist.scrollTop(messagelist.prop("scrollHeight"))},renderComponent=utterance=>{const messagelist=(0,_jquery.default)("#block_chatbot-messagelist"),messageBubble=document.createElement("div");messageBubble.className="block_chatbot-speech-bubble block_chatbot-system";const message=document.createElement("div");message.className="block_chatbot-message",message.style.color="anthrazit";const args=utterance.split(";"),component_type=args[0].replace("$$","");if("DONUT"===component_type){const outerTitle=args[1],outerValue=args[2],innerTitle=args.length>3?args[3]:null,innerValue=args.length>4?args[4]:null,plot=new _donut.default(outerValue,outerTitle,innerValue,innerTitle).render();message.append(plot),messageBubble.append(message),messagelist.append(messageBubble)}else if("LINECHART"===component_type){const legendTitle1=args[1],values1=JSON.parse(args[2]),legendTitle2=args[3],values2=JSON.parse(args[4]);var plot=document.createElement("div");plot.className="block_chatbot-plotly-chart",message.append(plot),messageBubble.append(message),messagelist.append(messageBubble),new _line.default(plot,legendTitle1,values1,legendTitle2,values2).render(Plotly)}else if("QUIZ"===component_type){const quiz_args=JSON.parse(args[1]);messageBubble.style.width="80%",message.style.width="100%";var iframe=document.createElement("iframe");iframe.src="".concat(quiz_args.host,"/h5p/embed.php?url=").concat(quiz_args.host,"/pluginfile.php/").concat(quiz_args.context)+"/mod_h5pactivity/".concat(quiz_args.filearea,"/").concat(quiz_args.itemid,"/").concat(quiz_args.filename)+"&preventredirect=1&component=mod_h5pactivity",iframe.className="h5p-player border-0 block_chatbot-quiz",message.append(iframe),messageBubble.append(message),messagelist.append(messageBubble)}},createAnswerCandidateButton=candidate=>{var button=document.createElement("p");return button.className="block_chatbot-answer_candidate",button.textContent=candidate,button.setAttribute("data-action","block_chatbot/answerCandidate"),button},addSystemMessage=function(utterance){let shouldScroll=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const messagelist=(0,_jquery.default)("#block_chatbot-messagelist"),content=utterance[0],answerCandidates=utterance[1];extend_chat_history("system",utterance);const scrollTop=messagelist.prop("scrollHeight");if(content.startsWith("$$"))renderComponent(content);else{var systemBubble=document.createElement("div");systemBubble.className="block_chatbot-speech-bubble block_chatbot-system";var systemMessage=document.createElement("div");if(systemMessage.innerHTML=content,systemMessage.className="block_chatbot-message",systemMessage.style.color="anthrazit",systemBubble.append(systemMessage),answerCandidates.length>0){var answer_candidate_el=document.createElement("div");answer_candidate_el.className="block_chatbot-answer_candidate_list",answerCandidates.forEach((cand=>answer_candidate_el.append(createAnswerCandidateButton(cand)))),systemBubble.append(answer_candidate_el)}messagelist.append(systemBubble)}shouldScroll||messagelist.scrollTop(scrollTop)},setWindowState=maximized=>{maximized?((0,_jquery.default)("#block_chatbot-messagelist").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-inputContainer").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-chatwindowInner").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-headerMinimized").addClass("block_chatbot-hidden")):((0,_jquery.default)("#block_chatbot-messagelist").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-inputContainer").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-chatwindowInner").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-headerMinimized").removeClass("block_chatbot-hidden")),localStorage.setItem("chatbot.maximized",maximized?"true":"false")},resizeWindow=size=>{"UI_SIZE_DEFAULT"==size?((0,_jquery.default)(".block_chatbot-chatwindowInner").removeClass("block_chatbot-big"),(0,_jquery.default)(".block_chatbot-chatwindowInner").addClass("block_chatbot-default")):"UI_SIZE_LARGE"==size&&((0,_jquery.default)(".block_chatbot-chatwindowInner").removeClass("block_chatbot-default"),(0,_jquery.default)(".block_chatbot-chatwindowInner").addClass("block_chatbot-big")),localStorage.setItem("chatbot.size",size)};class ChatbotConnection{constructor(server_name,server_port,wwwroot,userid,courseid,slidefindertoken,wsuserid,timestamp){_defineProperty(this,"openConnection",(()=>{this.conn=new WebSocket("".concat(this.protocol,"://").concat(this.server_name,":").concat(this.server_port,"/ws?token=").concat(this.userid)),this.conn.onopen=()=>{console.log("connected",this.userid);const start_dialog_msg={access_token:this.userid,domain:0,topic:"start_dialog",courseid:this.courseid,slidefindertoken:this.slidefindertoken,wsuserid:this.wsuserid,timestamp:this.timestamp};this.conn.send(JSON.stringify(start_dialog_msg))},this.conn.onmessage=msg=>{JSON.parse(msg.data).forEach((message=>{"system"===message.party?addSystemMessage(message.content):"control"===message.party?"UI_OPEN"===message.content?setWindowState(!0):message.content.startsWith("UI_SIZE")?resizeWindow(message.content):message.content.startsWith("UI_SETTINGS")&&(openSettingsModal(),(0,_jquery.default)("#block_chatbot_settingsModal").modal("show")):addUserMessage(message.content)}))},this.conn.onclose=()=>{this.conn.close(),setTimeout(this.openConnection,2500)}})),_defineProperty(this,"sendMessage",(message=>{const msg={userid:this.userid,domain:0,topic:"user_utterance",courseid:this.courseid,msg:message};this.conn.send(JSON.stringify(msg))})),this.server_name=server_name,this.server_port=server_port,this.wwwroot=wwwroot,this.protocol=wwwroot.startsWith("https://")?"wss":"ws",this.userid=userid,this.courseid=courseid,this.slidefindertoken=slidefindertoken,this.wsuserid=wsuserid,this.timestamp=timestamp,this.conn=null}}_exports.init=(server_name,server_port,wwwroot,userid,username,courseid,slidefindertoken,wsuserid,timestamp,plotly)=>{if(window.location!==window.parent.location)return void console.log("IFrame detected - Chatbot won't be loaded");Plotly=plotly,document.addEventListener("click",(e=>{if(e.target.closest(_selectors.default.actions.sendMessage)){const user_input=(0,_jquery.default)("#block_chatbot-userUtterance").val();sendMessage(user_input)}else if(e.target.closest(_selectors.default.actions.answerCandidate)){const msg=e.target.textContent;sendMessage(msg)}else if(e.target.closest(_selectors.default.actions.toggleWindowState))setWindowState(!("true"===localStorage.getItem("chatbot.maximized")));else if(e.target.closest(_selectors.default.actions.toggleWindowSize)){const new_size="UI_SIZE_DEFAULT"===localStorage.getItem("chatbot.size")?"UI_SIZE_LARGE":"UI_SIZE_DEFAULT";resizeWindow(new_size)}else if(e.target.closest(_selectors.default.actions.help))sendMessage("Hilfe");else if(e.target.closest(_selectors.default.actions.settings))setWindowState(!1),openSettingsModal();else if(e.target.closest(_selectors.default.actions.saveSettings)){e.preventDefault();const settings=(0,_settings.readUserSettings)();(0,_settings.saveUserSetttings)(conn.userid,conn.slidefindertoken,conn.wwwroot,settings).then((result=>{}))}})),document.addEventListener("keydown",(e=>{if(e.target.closest(_selectors.default.actions.textInput)&&"Enter"===e.key){const user_input=(0,_jquery.default)("#block_chatbot-userUtterance").val();sendMessage(user_input)}})),(conn=new ChatbotConnection(server_name,server_port,wwwroot,userid,courseid,slidefindertoken,wsuserid,timestamp)).openConnection();const chatwindow=(0,_jquery.default)("#block_chatbot-chatwindow");return chatwindow.detach(),(0,_jquery.default)(document.body).append(chatwindow),(()=>{const storage_history=localStorage.getItem("chatbot.history");(null===storage_history?[]:JSON.parse(storage_history)).forEach((item=>{"user"===item.party?addUserMessage(item.message,!1):"system"===item.party&&addSystemMessage(item.message,!1)}))})(),null===localStorage.getItem("chatbot.maximized")&&localStorage.setItem("chatbot.maximized","false"),setWindowState(!1),null===localStorage.getItem("chatbot.size")&&localStorage.setItem("chatbot.size","UI_SIZE_DEFAULT"),resizeWindow(localStorage.getItem("chatbot.size")),document.addEventListener("click",(function(event){var chatbot=document.getElementById("block_chatbot-chatwindow");event.target===chatbot||chatbot.contains(event.target)||event.target.className.includes("block_chatbot")||setWindowState(!1)})),conn}}));

//# sourceMappingURL=chatbot.min.js.map