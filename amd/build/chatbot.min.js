define("block_chatbot/chatbot",["exports","./local/selectors","./local/charts/donut/donut","./local/charts/line/line","jquery"],(function(_exports,_selectors,_donut,_line,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_selectors=_interopRequireDefault(_selectors),_donut=_interopRequireDefault(_donut),_line=_interopRequireDefault(_line),_jquery=_interopRequireDefault(_jquery);const sendMessage=user_input=>{console.log("SENDING",user_input),conn.sendMessage(user_input),addUserMessage(user_input);(0,_jquery.default)("#block_chatbot-userUtterance").val("")},addUserMessage=utterance=>{(0,_jquery.default)(".block_chatbot-answer_candidate_list").remove();const messagelist=(0,_jquery.default)("#block_chatbot-messagelist");messagelist.append('\n        <div class="block_chatbot-speech-bubble block_chatbot-user">\n            <div class="block_chatbot-message" style="color: anthrazit">'.concat(utterance,"</div>\n        </div>\n    ")),messagelist.animate({scrollTop:messagelist.prop("scrollHeight")},500)},addSystemMessage=utterance=>{const messagelist=(0,_jquery.default)("#block_chatbot-messagelist"),content=utterance[0],answerCandidates=utterance[1];if(content.startsWith("$$"))(utterance=>{const messagelist=(0,_jquery.default)("#block_chatbot-messagelist"),messageBubble=document.createElement("div");messageBubble.className="block_chatbot-speech-bubble block_chatbot-system";const message=document.createElement("div");message.className="block_chatbot-message",message.style.color="anthrazit";const args=utterance.split(";"),component_type=args[0].replace("$$","");if("DONUT"===component_type){const outerTitle=args[1],outerValue=args[2],innerTitle=args.length>3?args[3]:null,innerValue=args.length>4?args[4]:null,plot=new _donut.default(outerValue,outerTitle,innerValue,innerTitle).render();message.append(plot),messageBubble.append(message),messagelist.append(messageBubble)}else if("LINECHART"===component_type){const legendTitle1=args[1],values1=JSON.parse(args[2]),legendTitle2=args[3],values2=JSON.parse(args[4]);var plot=document.createElement("div");plot.className="block_chatbot-plotly-chart",console.log("TITLE",legendTitle1,",",legendTitle2),console.log("DATA1",values1),console.log("DATA2",values2),message.append(plot),messageBubble.append(message),messagelist.append(messageBubble),new _line.default(plot,legendTitle1,values1,legendTitle2,values2).render(Plotly)}else if("QUIZ"===component_type){const quiz_args=JSON.parse(args[1]);console.log("QUIZ ARGS",quiz_args),messageBubble.style.width="80%",message.style.width="100%";var iframe=document.createElement("iframe");iframe.src="".concat(quiz_args.host,"/h5p/embed.php?url=").concat(quiz_args.host,"/pluginfile.php/").concat(quiz_args.context)+"/mod_h5pactivity/".concat(quiz_args.filearea,"/").concat(quiz_args.itemid,"/").concat(quiz_args.filename)+"&preventredirect=1&component=mod_h5pactivity",iframe.className="h5p-player border-0 block_chatbot-quiz",message.append(iframe),messageBubble.append(message),messagelist.append(messageBubble)}})(content);else{var systemBubble=document.createElement("div");systemBubble.className="block_chatbot-speech-bubble block_chatbot-system";var systemMessage=document.createElement("div");if(systemMessage.innerHTML=content,systemMessage.className="block_chatbot-message",systemMessage.style.color="anthrazit",systemBubble.append(systemMessage),answerCandidates.length>0){var answer_candidate_el=document.createElement("div");answer_candidate_el.className="block_chatbot-answer_candidate_list",answerCandidates.forEach((cand=>{return answer_candidate_el.append((candidate=cand,(button=document.createElement("p")).className="block_chatbot-answer_candidate",button.textContent=candidate,button.onclick=()=>sendMessage(candidate),button));var candidate,button})),systemBubble.append(answer_candidate_el)}messagelist.append(systemBubble)}messagelist.animate({scrollTop:messagelist.prop("scrollHeight")},500)},setWindowState=maximized=>{console.log("Window state",maximized),maximized?((0,_jquery.default)("#block_chatbot-messagelist").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-inputContainer").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-chatwindowInner").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-headerMinimized").addClass("block_chatbot-hidden")):((0,_jquery.default)("#block_chatbot-messagelist").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-inputContainer").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-chatwindowInner").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-headerMinimized").removeClass("block_chatbot-hidden")),localStorage.setItem("chatbot.maximized",maximized?"true":"false")};class ChatbotConnection{constructor(server_name,server_port,userid,courseid,slidefindertoken,timestamp){_defineProperty(this,"openConnection",(()=>{console.log("Connecting to: ws://".concat(this.server_name,":").concat(this.server_port,"/ws?token=").concat(this.userid)),this.conn=new WebSocket("ws://".concat(this.server_name,":").concat(this.server_port,"/ws?token=").concat(this.userid)),this.conn.onopen=()=>{console.log("connected",this.userid);const start_dialog_msg={access_token:this.userid,domain:0,topic:"start_dialog",courseid:this.courseid,slidefindertoken:this.slidefindertoken,timestamp:this.timestamp};console.log("START MSG",start_dialog_msg),this.conn.send(JSON.stringify(start_dialog_msg))},this.conn.onmessage=msg=>{const data=JSON.parse(msg.data);console.log("Received data",data),data.forEach((message=>{var size;"system"===message.party?addSystemMessage(message.content):"control"===message.party?"UI_OPEN"===message.content?setWindowState(!0):message.content.startsWith("UI_SIZE")&&(size=message.content,console.log("Resize to",size),"UI_SIZE_DEFAULT"==size?((0,_jquery.default)(".block_chatbot-chatwindowInner").removeClass("block_chatbot-big"),(0,_jquery.default)(".block_chatbot-chatwindowInner").addClass("block_chatbot-default")):"UI_SIZE_LARGE"==size&&((0,_jquery.default)(".block_chatbot-chatwindowInner").removeClass("block_chatbot-default"),(0,_jquery.default)(".block_chatbot-chatwindowInner").addClass("block_chatbot-big"))):addUserMessage(message.content)}))}})),_defineProperty(this,"sendMessage",(message=>{const msg={userid:this.userid,domain:0,topic:"user_utterance",courseid:this.courseid,msg:message};console.log("Sending message",msg),this.conn.send(JSON.stringify(msg))})),this.server_name=server_name,this.server_port=server_port,this.userid=userid,this.courseid=courseid,this.slidefindertoken=slidefindertoken,this.timestamp=timestamp,this.conn=null}}var conn,Plotly;_exports.init=(server_name,server_port,server_url,userid,username,courseid,slidefindertoken,timestamp,plotly)=>{if(window.location!==window.parent.location)return void console.log("IFrame detected - Chatbot won't be loaded");console.log("SERVER",server_name),console.log("PORT",server_port),console.log("URL",server_url),console.log("USER",userid,username),console.log("COURSE",courseid),console.log("SLIDEFINDER TOKEN",slidefindertoken),console.log("TIMESTAMP",timestamp),Plotly=plotly,document.addEventListener("click",(e=>{if(e.target.closest(_selectors.default.actions.maximiseChatWindow))window.alert("MAXIMISE");else if(e.target.closest(_selectors.default.actions.minimizeChatWindow))window.alert("MINIMIZE");else if(e.target.closest(_selectors.default.actions.sendMessage)){const user_input=(0,_jquery.default)("#block_chatbot-userUtterance").val();sendMessage(user_input)}else e.target.closest(_selectors.default.actions.toggleWindowState)&&setWindowState(!("true"===localStorage.getItem("chatbot.maximized")))})),document.addEventListener("keydown",(e=>{if(e.target.closest(_selectors.default.actions.textInput)&&"Enter"===e.key){const user_input=(0,_jquery.default)("#block_chatbot-userUtterance").val();sendMessage(user_input)}})),(conn=new ChatbotConnection(server_name,server_port,userid,courseid,slidefindertoken,timestamp)).openConnection();const chatwindow=(0,_jquery.default)("#block_chatbot-chatwindow");return chatwindow.detach(),(0,_jquery.default)(document.body).append(chatwindow),null===localStorage.getItem("chatbot.maximized")&&localStorage.setItem("chatbot.maximized","false"),setWindowState("true"===localStorage.getItem("chatbot.maximized")),document.addEventListener("click",(function(event){var chatbot=document.getElementById("block_chatbot-chatwindow");event.target===chatbot||chatbot.contains(event.target)||setWindowState(!1)})),conn}}));

//# sourceMappingURL=chatbot.min.js.map