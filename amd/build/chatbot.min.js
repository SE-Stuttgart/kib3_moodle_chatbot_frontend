define("block_chatbot/chatbot",["exports","./local/selectors","./local/charts/donut/donut","jquery"],(function(_exports,_selectors,_donut,_jquery){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_selectors=_interopRequireDefault(_selectors),_donut=_interopRequireDefault(_donut),_jquery=_interopRequireDefault(_jquery);const sendMessage=()=>{const textInputField=(0,_jquery.default)("#block_chatbot-userUtterance"),user_input=textInputField.val();conn.sendMessage(user_input),addUserMessage(user_input),textInputField.val("")},addUserMessage=utterance=>{const messagelist=(0,_jquery.default)("#block_chatbot-messagelist");messagelist.append('\n        <div class="block_chatbot-speech-bubble block_chatbot-user">\n            <div class="block_chatbot-message" style="color: anthrazit">'.concat(utterance,"</div>\n        </div>\n    ")),messagelist.animate({scrollTop:messagelist.prop("scrollHeight")},500)},addSystemMessage=utterance=>{const messagelist=(0,_jquery.default)("#block_chatbot-messagelist");if(utterance.startsWith("$DONUT")){const messageBubble=document.createElement("div");messageBubble.className="block_chatbot-speech-bubble block_chatbot-system";const message=document.createElement("div");message.className="block_chatbot-message",message.style.color="anthrazit",message.append((utterance=>{if(utterance.startsWith("$DONUT")){const args=utterance.split(","),outerValue=args[1],innerValue=args[2];return new _donut.default(outerValue,"Kurs",innerValue,"Wiederholte Quizze").render()}})(utterance)),messageBubble.append(message),messagelist.append(messageBubble)}else messagelist.append('\n            <div class="block_chatbot-speech-bubble block_chatbot-system">\n                <div class="block_chatbot-message" style="color: anthrazit">'.concat(utterance,"</div>\n            </div>"));messagelist.animate({scrollTop:messagelist.prop("scrollHeight")},500)},setWindowState=maximized=>{console.log("Window state",maximized),maximized?((0,_jquery.default)("#block_chatbot-messagelist").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-inputContainer").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-chatwindowInner").removeClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-headerMinimized").addClass("block_chatbot-hidden")):((0,_jquery.default)("#block_chatbot-messagelist").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-inputContainer").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-chatwindowInner").addClass("block_chatbot-hidden"),(0,_jquery.default)(".block_chatbot-headerMinimized").removeClass("block_chatbot-hidden")),localStorage.setItem("chatbot.maximized",maximized?"true":"false")};class ChatbotConnection{constructor(server_name,server_port,userid,courseid,slidefindertoken){_defineProperty(this,"openConnection",(()=>{console.log("Connecting to: ws://".concat(this.server_name,":").concat(this.server_port,"/ws?token=").concat(this.userid)),this.conn=new WebSocket("ws://".concat(this.server_name,":").concat(this.server_port,"/ws?token=").concat(this.userid)),this.conn.onopen=()=>{console.log("connected",this.userid);const start_dialog_msg={access_token:this.userid,domain:0,topic:"start_dialog",courseid:this.courseid,slidefindertoken:this.slidefindertoken};console.log("START MSG",start_dialog_msg),this.conn.send(JSON.stringify(start_dialog_msg))},this.conn.onmessage=msg=>{const data=JSON.parse(msg.data);console.log("Received data",data),data.forEach((message=>{"system"===message.party?addSystemMessage(message.content):"control"===message.party?"UI_OPEN"===message.content&&setWindowState(!0):addUserMessage(message.content)}))}})),_defineProperty(this,"sendMessage",(message=>{const msg={userid:this.userid,domain:0,topic:"user_utterance",courseid:this.courseid,msg:message};console.log("Sending message",msg),this.conn.send(JSON.stringify(msg))})),this.server_name=server_name,this.server_port=server_port,this.userid=userid,this.courseid=courseid,this.slidefindertoken=slidefindertoken,this.conn=null}}var conn;_exports.init=(server_name,server_port,server_url,userid,username,courseid,slidefindertoken)=>{if(window.location!==window.parent.location)return void console.log("IFrame detected - Chatbot won't be loaded");console.log("SERVER",server_name),console.log("PORT",server_port),console.log("URL",server_url),console.log("USER",userid,username),console.log("COURSE",courseid),console.log("SLIDEFINDER TOKEN",slidefindertoken),document.addEventListener("click",(e=>{e.target.closest(_selectors.default.actions.maximiseChatWindow)?window.alert("MAXIMISE"):e.target.closest(_selectors.default.actions.minimizeChatWindow)?window.alert("MINIMIZE"):e.target.closest(_selectors.default.actions.sendMessage)?sendMessage():e.target.closest(_selectors.default.actions.toggleWindowState)&&setWindowState(!("true"===localStorage.getItem("chatbot.maximized")))})),document.addEventListener("keydown",(e=>{e.target.closest(_selectors.default.actions.textInput)&&"Enter"===e.key&&sendMessage()})),(conn=new ChatbotConnection(server_name,server_port,userid,courseid,slidefindertoken)).openConnection();const chatwindow=(0,_jquery.default)("#block_chatbot-chatwindow");return chatwindow.detach(),(0,_jquery.default)(document.body).append(chatwindow),null===localStorage.getItem("chatbot.maximized")&&localStorage.setItem("chatbot.maximized","false"),setWindowState("true"===localStorage.getItem("chatbot.maximized")),conn}}));

//# sourceMappingURL=chatbot.min.js.map