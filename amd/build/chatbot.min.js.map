{"version":3,"file":"chatbot.min.js","sources":["../src/chatbot.js"],"sourcesContent":["import Selectors from './local/selectors';\nimport DonutChart from './local/charts/donut/donut';\nimport LineChart from './local/charts/line/line';\nimport $ from 'jquery';\n\n\nconst registerEventListeners = () => {\n    document.addEventListener('click', e => {\n        if (e.target.closest(Selectors.actions.maximiseChatWindow)) {\n            window.alert(\"MAXIMISE\");\n        } else if(e.target.closest(Selectors.actions.minimizeChatWindow)) {\n            window.alert(\"MINIMIZE\");\n        } else if(e.target.closest(Selectors.actions.sendMessage)) {\n            // get value of input field, then send\n            const textInputField = $(\"#block_chatbot-userUtterance\");\n            const user_input = textInputField.val();\n            sendMessage(user_input);\n        } else if(e.target.closest(Selectors.actions.toggleWindowState)) {\n            setWindowState(!(localStorage.getItem(\"chatbot.maximized\") === \"true\"));\n        }\n    });\n    document.addEventListener('keydown', e => {\n        if (e.target.closest(Selectors.actions.textInput)) {\n            if(e.key === \"Enter\") {\n                // get value of input field, then send\n                const textInputField = $(\"#block_chatbot-userUtterance\");\n                const user_input = textInputField.val();\n                sendMessage(user_input);\n            }\n        }\n    });\n};\n\nconst sendMessage = (user_input) => {\n    console.log(\"SENDING\", user_input);\n    // forwad value of input field to socket & send message\n    conn.sendMessage(user_input);\n    // show user message in messagelist\n    addUserMessage(user_input);\n    // clear input field\n    const textInputField = $(\"#block_chatbot-userUtterance\");\n    textInputField.val(\"\");\n};\n\n\nconst addUserMessage = (utterance) => {\n    /*\n    Adds a new messagebox to the message list\n    Args:\n        utterance (String): the user utterance\n    */\n   // remove answer candidates\n    $(\".block_chatbot-answer_candidate_list\").remove();\n\n    // add user message\n    const messagelist = $('#block_chatbot-messagelist');\n    messagelist.append(`\n        <div class=\"block_chatbot-speech-bubble block_chatbot-user\">\n            <div class=\"block_chatbot-message\" style=\"color: anthrazit\">${utterance}</div>\n        </div>\n    `);\n\n    // scroll to newest message\n    messagelist.animate({ scrollTop: messagelist.prop(\"scrollHeight\")}, 500);\n};\n\nconst renderChart = (utterance) => {\n    const messagelist = $('#block_chatbot-messagelist');\n    const messageBubble = document.createElement(\"div\");\n    messageBubble.className = \"block_chatbot-speech-bubble block_chatbot-system\";\n    const message = document.createElement(\"div\");\n    message.className = \"block_chatbot-message\";\n    message.style.color = \"anthrazit\";\n\n    const args = utterance.split(\";\");\n    const chart_type = args[0].replace(\"$$\", \"\");\n    if(chart_type === \"DONUT\") {\n        const outerTitle = args[1];\n        const outerValue = args[2];\n        const innerTitle = args.length > 3? args[3] : null;\n        const innerValue = args.length > 4? args[4] : null;\n        const plot = new DonutChart(outerValue, outerTitle, innerValue, innerTitle).render();\n        message.append(plot);\n        messageBubble.append(message);\n        messagelist.append(messageBubble);\n    } else if(chart_type === \"LINECHART\") {\n        const legendTitle1 = args[1];\n        const values1 = JSON.parse(args[2]);\n        const legendTitle2 = args[3];\n        const values2 = JSON.parse(args[4]);\n        var plot = document.createElement(\"div\");\n        plot.className = \"block_chatbot-plotly-chart\";\n        console.log(\"TITLE\", legendTitle1, \",\", legendTitle2);\n        console.log(\"DATA1\", values1);\n        console.log(\"DATA2\", values2);\n        message.append(plot);\n        messageBubble.append(message);\n        messagelist.append(messageBubble);\n        new LineChart(plot, legendTitle1, values1, legendTitle2, values2).render(Plotly);\n    }\n};\n\nconst createAnswerCandidateButton = (candidate) => {\n    var button = document.createElement(\"p\");\n    button.className = \"block_chatbot-answer_candidate\";\n    button.textContent = candidate;\n    button.onclick = () => sendMessage(candidate);\n    return button;\n};\n\nconst addSystemMessage = (utterance) => {\n    /*\n    Adds a new messagebox to the message list\n    Args:\n        utterance (String): the system utterance\n    */\n    const messagelist = $('#block_chatbot-messagelist');\n    const content = utterance[0];\n    const answerCandidates = utterance[1];\n\n    if(content.startsWith(\"$$\")) {\n        renderChart(content);\n    } else {\n        var systemBubble = document.createElement(\"div\");\n        systemBubble.className = \"block_chatbot-speech-bubble block_chatbot-system\";\n        var systemMessage = document.createElement(\"div\");\n        systemMessage.innerHTML = content;\n        systemMessage.className = \"block_chatbot-message\";\n        systemMessage.style.color = \"anthrazit\";\n        systemBubble.append(systemMessage);\n        if(answerCandidates.length > 0) {\n            var answer_candidate_el = document.createElement(\"div\");\n            answer_candidate_el.className = \"block_chatbot-answer_candidate_list\";\n            answerCandidates.forEach(cand => answer_candidate_el.append(createAnswerCandidateButton(cand)));\n            systemBubble.append(answer_candidate_el);\n        }\n        messagelist.append(systemBubble);\n    }\n\n    // scroll to newest message\n    messagelist.animate({ scrollTop: messagelist.prop(\"scrollHeight\")}, 500);\n};\n\nconst setWindowState = (maximized) => {\n    console.log(\"Window state\", maximized);\n\n    if(maximized) {\n        $(\"#block_chatbot-messagelist\").removeClass('block_chatbot-hidden');\n        $(\".block_chatbot-inputContainer\").removeClass('block_chatbot-hidden');\n        $(\".block_chatbot-chatwindowInner\").removeClass('block_chatbot-hidden');\n        $(\".block_chatbot-headerMinimized\").addClass('block_chatbot-hidden');\n    } else {\n        $(\"#block_chatbot-messagelist\").addClass('block_chatbot-hidden');\n        $(\".block_chatbot-inputContainer\").addClass('block_chatbot-hidden');\n        $(\".block_chatbot-chatwindowInner\").addClass('block_chatbot-hidden');\n        $(\".block_chatbot-headerMinimized\").removeClass('block_chatbot-hidden');\n    }\n    // remember state\n    localStorage.setItem(\"chatbot.maximized\", maximized? \"true\" : \"false\");\n};\n\nclass ChatbotConnection {\n    constructor(server_name, server_port, userid, courseid, slidefindertoken, timestamp) {\n        this.server_name = server_name;\n        this.server_port = server_port;\n        this.userid = userid;\n        this.courseid = courseid;\n        this.slidefindertoken = slidefindertoken;\n        this.timestamp = timestamp;\n        this.conn = null;\n    }\n\n    openConnection = () => {\n        console.log(`Connecting to: ws://${this.server_name}:${this.server_port}/ws?token=${this.userid}`);\n        this.conn = new WebSocket(`ws://${this.server_name}:${this.server_port}/ws?token=${this.userid}`);\n\n        this.conn.onopen = () => {\n            // Update Status to Online\n            console.log('connected', this.userid);\n\n            const start_dialog_msg = {\n                access_token: this.userid,\n                domain: 0,\n                topic: 'start_dialog',\n                courseid: this.courseid,\n                slidefindertoken: this.slidefindertoken,\n                timestamp: this.timestamp\n            };\n\n            console.log(\"START MSG\", start_dialog_msg);\n            this.conn.send(JSON.stringify(start_dialog_msg));\n        };\n        this.conn.onmessage = (msg) => {\n            // Parse received data\n            const data = JSON.parse(msg.data);\n            console.log(\"Received data\", data);\n            // render each message\n            data.forEach(message => {\n                if(message.party === \"system\") {\n                    addSystemMessage(message.content);\n                } else if(message.party === \"control\") {\n                    if(message.content === \"UI_OPEN\") {\n                        setWindowState(true);\n                    }\n                }\n                else {\n                    addUserMessage(message.content);\n                }\n            });\n        };\n    };\n\n    sendMessage = (message) => {\n        const msg = {\n            userid: this.userid,\n            domain: 0,\n            topic: 'user_utterance',\n            courseid: this.courseid,\n            msg: message\n        };\n        console.log(\"Sending message\", msg);\n        this.conn.send(JSON.stringify(msg));\n    };\n}\n\nconst isInsideIFrame = () => {\n    if (window.location !== window.parent.location)\n    {\n        // inside iframe\n        return true;\n    }\n    else {\n        // The page is not in an iFrame\n        return false;\n    }\n};\n\nvar conn;\nvar Plotly;\n\nexport const init = (server_name, server_port, server_url, userid, username, courseid, slidefindertoken, timestamp, plotly) => {\n    if(isInsideIFrame()) {\n        console.log(\"IFrame detected - Chatbot won't be loaded\");\n        return;\n    }\n    console.log(\"SERVER\", server_name);\n    console.log(\"PORT\", server_port);\n    console.log(\"URL\", server_url);\n    console.log(\"USER\", userid, username);\n    console.log(\"COURSE\", courseid);\n    console.log(\"SLIDEFINDER TOKEN\", slidefindertoken);\n    console.log(\"TIMESTAMP\", timestamp);\n\n    Plotly = plotly;\n    registerEventListeners();\n    conn = new ChatbotConnection(server_name, server_port, userid, courseid, slidefindertoken, timestamp);\n    conn.openConnection();\n\n    // Move container into document root\n    const chatwindow = $(\"#block_chatbot-chatwindow\");\n    chatwindow.detach();\n    $(document.body).append(chatwindow);\n\n    // Set or restore minimized state\n    if (localStorage.getItem(\"chatbot.maximized\") === null) {\n        localStorage.setItem(\"chatbot.maximized\", \"false\");\n    }\n    setWindowState(localStorage.getItem(\"chatbot.maximized\") === \"true\");\n\n    // Minimize chatbot when clicking outside\n    document.addEventListener('click', function(event) {\n        var chatbot = document.getElementById('block_chatbot-chatwindow');\n        // Check if the clicked element is outside the \"chatbot\" div\n        if (event.target !== chatbot && !chatbot.contains(event.target)) {\n            // Check if the clicked element is not inside the \"chatbot\" div\n            setWindowState(false);\n        }\n    });\n\n    return conn;\n};\n"],"names":["sendMessage","user_input","console","log","conn","addUserMessage","val","utterance","remove","messagelist","append","animate","scrollTop","prop","addSystemMessage","content","answerCandidates","startsWith","messageBubble","document","createElement","className","message","style","color","args","split","chart_type","replace","outerTitle","outerValue","innerTitle","length","innerValue","plot","DonutChart","render","legendTitle1","values1","JSON","parse","legendTitle2","values2","LineChart","Plotly","renderChart","systemBubble","systemMessage","innerHTML","answer_candidate_el","forEach","cand","candidate","button","textContent","onclick","setWindowState","maximized","removeClass","addClass","localStorage","setItem","ChatbotConnection","constructor","server_name","server_port","userid","courseid","slidefindertoken","timestamp","this","WebSocket","onopen","start_dialog_msg","access_token","domain","topic","send","stringify","onmessage","msg","data","party","server_url","username","plotly","window","location","parent","addEventListener","e","target","closest","Selectors","actions","maximiseChatWindow","alert","minimizeChatWindow","toggleWindowState","getItem","textInput","key","openConnection","chatwindow","detach","body","event","chatbot","getElementById","contains"],"mappings":"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"}