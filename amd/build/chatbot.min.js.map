{"version":3,"file":"chatbot.min.js","sources":["../src/chatbot.js"],"sourcesContent":["import Selectors from './local/selectors';\nimport $ from 'jquery';\n\n\nconst registerEventListeners = () => {\n    document.addEventListener('click', e => {\n        if (e.target.closest(Selectors.actions.maximiseChatWindow)) {\n            window.alert(\"MAXIMISE\");\n        } else if(e.target.closest(Selectors.actions.minimizeChatWindow)) {\n            window.alert(\"MINIMIZE\");\n        } else if(e.target.closest(Selectors.actions.sendMessage)) {\n            sendMessage();\n        } else if(e.target.closest(Selectors.actions.toggleWindowState)) {\n            setWindowState(!(localStorage.getItem(\"chatbot.maximized\") === \"true\"));\n        }\n    });\n    document.addEventListener('keydown', e => {\n        if (e.target.closest(Selectors.actions.textInput)) {\n            if(e.key === \"Enter\") {\n              sendMessage();\n            }\n        }\n    });\n};\n\nconst sendMessage = () => {\n    const textInputField = $(\"#block_chatbot-userUtterance\");\n    // get value of input field\n    const user_input = textInputField.val();\n    // forwad value of input field to socket & send message\n    conn.sendMessage(user_input);\n    // show user message in messagelist\n    addUserMessage(user_input);\n    // clear input field\n    textInputField.val(\"\");\n};\n\nconst addUserMessage = (utterance) => {\n    /*\n    Adds a new messagebox to the message list\n    Args:\n        utterance (String): the user utterance\n    */\n    const messagelist = $('#block_chatbot-messagelist');\n    messagelist.append(`\n        <div class=\"block_chatbot-speech-bubble block_chatbot-user\">\n            <div class=\"block_chatbot-message\" style=\"color: anthrazit\">${utterance}</div>\n        </div>\n    `);\n    // scroll to newest message\n    messagelist.animate({ scrollTop: messagelist.prop(\"scrollHeight\")}, 500);\n};\n\nconst addSystemMessage = (utterance) => {\n    /*\n    Adds a new messagebox to the message list\n    Args:\n        utterance (String): the system utterance\n    */\n    const messagelist = $('#block_chatbot-messagelist');\n    messagelist.append(`\n        <div class=\"block_chatbot-speech-bubble block_chatbot-system\">\n            <div class=\"block_chatbot-message\" style=\"color: anthrazit\">${utterance}</div>\n        </div>\n    `);\n    // scroll to newest message\n    messagelist.animate({ scrollTop: messagelist.prop(\"scrollHeight\")}, 500);\n};\n\nconst setWindowState = (maximized) => {\n    console.log(\"Window state\", maximized);\n    $(\"#block_chatbot-toggleWindowState\").html(maximized? \"-\" : \"+\");\n\n    if(maximized) {\n        $(\"#block_chatbot-messagelist\").removeClass('block_chatbot-hidden');\n        $(\".block_chatbot-inputContainer\").removeClass('block_chatbot-hidden');\n    } else {\n        $(\"#block_chatbot-messagelist\").addClass('block_chatbot-hidden');\n        $(\".block_chatbot-inputContainer\").addClass('block_chatbot-hidden');\n    }\n    // remember state\n    localStorage.setItem(\"chatbot.maximized\", maximized? \"true\" : \"false\");\n};\n\nclass ChatbotConnection {\n    constructor(server_name, server_port, userid, courseid, slidefindertoken) {\n        this.server_name = server_name;\n        this.server_port = server_port;\n        this.userid = userid;\n        this.courseid = courseid;\n        this.slidefindertoken = slidefindertoken;\n        this.conn = null;\n    }\n\n    openConnection = () => {\n        console.log(`Connecting to: ws://${this.server_name}:${this.server_port}/ws?token=${this.userid}`);\n        this.conn = new WebSocket(`ws://${this.server_name}:${this.server_port}/ws?token=${this.userid}`);\n\n        this.conn.onopen = () => {\n            // Update Status to Online\n            console.log('connected', this.userid);\n\n            const start_dialog_msg = {\n                access_token: this.userid,\n                domain: 0,\n                topic: 'start_dialog',\n                courseid: this.courseid,\n                slidefindertoken: this.slidefindertoken\n            };\n\n            console.log(\"START MSG\", start_dialog_msg);\n            this.conn.send(JSON.stringify(start_dialog_msg));\n        };\n        this.conn.onmessage = (msg) => {\n            // Parse received data\n            const data = JSON.parse(msg.data);\n            console.log(\"Received data\", data);\n            // render each message\n            data.forEach(message => {\n                if(message.party === \"system\") {\n                    addSystemMessage(message.content);\n                }\n                else {\n                    addUserMessage(message.content);\n                }\n            });\n        };\n    };\n\n    sendMessage = (message) => {\n        const msg = {\n            userid: this.userid,\n            domain: 0,\n            topic: 'user_utterance',\n            courseid: this.courseid,\n            msg: message\n        };\n        console.log(\"Sending message\", msg);\n        this.conn.send(JSON.stringify(msg));\n    };\n}\n\nconst isInsideIFrame = () => {\n    if (window.location !== window.parent.location)\n    {\n        // inside iframe\n        return true;\n    }\n    else {\n        // The page is not in an iFrame\n        return false;\n    }\n};\n\nvar conn;\n\n\nexport const init = (server_name, server_port, server_url, userid, username, courseid, slidefindertoken) => {\n    if(isInsideIFrame()) {\n        console.log(\"IFrame detected - Chatbot won't be loaded\");\n        return;\n    }\n    console.log(\"SERVER\", server_name);\n    console.log(\"PORT\", server_port);\n    console.log(\"URL\", server_url);\n    console.log(\"USER\", userid, username);\n    console.log(\"COURSE\", courseid);\n    console.log(\"SLIDEFINDER TOKEN\", slidefindertoken);\n\n    registerEventListeners();\n    conn = new ChatbotConnection(server_name, server_port, userid, courseid, slidefindertoken);\n    conn.openConnection();\n\n    // Move container into document root\n    const chatwindow = $(\"#block_chatbot-chatwindow\");\n    chatwindow.detach();\n    $(document.body).append(chatwindow);\n\n    // Set or restore minimized state\n    if (localStorage.getItem(\"chatbot.maximized\") === null) {\n        localStorage.setItem(\"chatbot.maximized\", \"false\");\n    }\n    setWindowState(localStorage.getItem(\"chatbot.maximized\") === \"true\");\n\n    return conn;\n};\n"],"names":["sendMessage","textInputField","user_input","val","conn","addUserMessage","utterance","messagelist","append","animate","scrollTop","prop","setWindowState","maximized","console","log","html","removeClass","addClass","localStorage","setItem","ChatbotConnection","constructor","server_name","server_port","userid","courseid","slidefindertoken","this","WebSocket","onopen","start_dialog_msg","access_token","domain","topic","send","JSON","stringify","onmessage","msg","data","parse","forEach","message","party","addSystemMessage","content","server_url","username","window","location","parent","document","addEventListener","e","target","closest","Selectors","actions","maximiseChatWindow","alert","minimizeChatWindow","toggleWindowState","getItem","textInput","key","openConnection","chatwindow","detach","body"],"mappings":"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"}